<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Aclara Admin ‚Äî OFFLINE (Compat)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#F472B6"/>
<style>
  :root{--bg:#FFF6FA;--text:#1F2937;--muted:#6B7280;--border:#F8D7E4;--card:#FFFFFF;--primary:#F472B6;--primary-700:#DB2777;--ring:rgba(244,114,182,.35);--shadow:0 10px 30px rgba(244,114,182,.08);--radius:14px}
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--text)}
  .container{max-width:1140px;margin:0 auto;padding:14px}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .title{font-size:20px;font-weight:800}
  .badge,.chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#F3F4F6;color:#374151}
  .card{border:1px solid var(--border);border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow)}
  .content{padding:14px}
  .btn{display:inline-flex;align-items:center;gap:8px;height:42px;padding:0 14px;font-size:14px;border-radius:12px;border:1px solid var(--border);background:white;color:var(--text);cursor:pointer}
  .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  .btn.red{background:#dc2626;color:#fff;border-color:#b91c1c}
  .input,.select,.textarea{width:100%;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;background:white}
  .label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
  .hint{font-size:12px;color:var(--muted)}
  .row{display:grid;gap:10px}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{text-align:left;padding:10px;border-bottom:1px solid #EEF2F7;vertical-align:top}
  thead{background:#F9FAFB}
  .preview-img{width:56px;height:56px;border-radius:10px;object-fit:cover;border:1px solid var(--border)}
  @media(min-width:900px){.row.cols-2{grid-template-columns:1fr 1fr}.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-4{grid-template-columns:repeat(4,1fr)}.layout-5{grid-template-columns:3fr 2fr}}
  @media(max-width:899px){.row.cols-2,.row.cols-3,.row.cols-4{grid-template-columns:1fr}.btn{height:48px}}
</style>
</head>
<body>
<div class="container" id="app"><div style="padding:24px;text-align:center;color:#6b7280">Cargando‚Ä¶</div></div>

<script>
(function(){
  // 100% ES5 para m√°xima compatibilidad
  try{
    // ===== Constantes/Utils =====
    var LS_KEY='aclara-legacy-v4';
    var LS_CATALOG='aclara-legacy-catalog-v1';
    var STATUS=['Nuevo','Pagado','Procesado','Empacado','Enviado','Entregado','Cancelado'];
    function currency(n){ n=Number(n||0); try{return new Intl.NumberFormat('es-DO',{style:'currency',currency:'DOP'}).format(n);}catch(e){return 'DOP '+n.toFixed(2);} }
    function uid(){ return Math.random().toString(36).slice(2,9); }
    function fileToDataURL(file,cb){ var r=new FileReader(); r.onload=function(){cb(String(r.result));}; r.onerror=function(){cb(null);}; r.readAsDataURL(file); }

    // ===== Code39 =====
    var CODE39={'0':'101001101101','1':'110100101011','2':'101100101011','3':'110110010101','4':'101001101011','5':'110100110101','6':'101100110101','7':'101001011011','8':'110100101101','9':'101100101101','A':'110101001011','B':'101101001011','C':'110110100101','D':'101011001011','E':'110101100101','F':'101101100101','G':'101010011011','H':'110101001101','I':'101101001101','J':'101011001101','K':'110101010011','L':'101101010011','M':'110110101001','N':'101011010011','O':'110101101001','P':'101101101001','Q':'101010110011','R':'110101011001','S':'101101011001','T':'101011011001','U':'110010101011','V':'100110101011','W':'110011010101','X':'100101101011','Y':'110010110101','Z':'100110110101','-':'100101011011','.':'110010101101',' ':'100110101101','*':'100101101101','/':'100101101001','+':'100101001101','%':'101001101001'};
    function toCode39(text){ text=String(text||''); text='*'+text.toUpperCase()+'*'; var out=''; for(var i=0;i<text.length;i++){ var ch=text.charAt(i); out+=(CODE39[ch]||CODE39[' '])+'0'; } return out; }
    function makeCode39SVG(bits,narrow,wide,height){ narrow=narrow||2; wide=wide||5; height=height||200; var x=0,bars=[]; for(var i=0;i<bits.length;i++){ var w=(bits.charAt(i)==='1'?wide:narrow); if(i%2===0){ bars.push("<rect x='"+x+"' y='0' width='"+w+"' height='"+height+"'/>"); } x+=w; } return "<svg xmlns='http://www.w3.org/2000/svg' width='"+x+"' height='"+height+"' viewBox='0 0 "+x+" "+height+"' shape-rendering='crispEdges'>"+bars.join('')+"</svg>"; }
    function toCode39SVG(text,narrow,wide,height){ return makeCode39SVG(toCode39(text),narrow,wide,height); }

    // ===== Impresi√≥n =====
    function openHTML(html){
      try{
        var blob=new Blob([html],{type:'text/html;charset=utf-8'});
        var url=URL.createObjectURL(blob);
        var w=window.open('', '_blank');
        if(w && !w.closed){ w.location=url; setTimeout(function(){URL.revokeObjectURL(url);},8000); return url; }
        var iframe=document.getElementById('print-fallback-frame');
        if(!iframe){ iframe=document.createElement('iframe'); iframe.id='print-fallback-frame'; iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0'; iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0'; iframe.style.opacity='0'; document.body.appendChild(iframe); }
        iframe.src=url; iframe.onload=function(){ try{ if(iframe.contentWindow){ iframe.contentWindow.focus && iframe.contentWindow.focus(); iframe.contentWindow.print && iframe.contentWindow.print(); } }catch(e){} };
        setTimeout(function(){URL.revokeObjectURL(url);},10000); return url;
      }catch(e){ alert('No se pudo abrir la impresi√≥n.'); }
    }

    // ===== Storage =====
    function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]'); }catch(e){ return []; } }
    function save(list){ try{ localStorage.setItem(LS_KEY, JSON.stringify(list)); }catch(e){} }
    function loadCatalog(){ try{ return JSON.parse(localStorage.getItem(LS_CATALOG)||'[]'); }catch(e){ return []; } }
    function saveCatalog(cat){ try{ localStorage.setItem(LS_CATALOG, JSON.stringify(cat)); }catch(e){} }

    // ===== Helpers UI =====
    function table(headers, rowsHtml){ var h=''; for(var i=0;i<headers.length;i++){ h+='<th>'+headers[i]+'</th>'; } return '<div class="card"><div class="content" style="padding:0"><table><thead><tr>'+h+'</tr></thead><tbody>'+rowsHtml+'</tbody></table></div></div>'; }
    function imgPreview(dataUrl){ return dataUrl?"<img src='"+dataUrl+"' class='preview-img' alt='img'/>":"<div class='preview-img' style='background:#f3f4f6'></div>"; }

    // ===== Render principal =====
    function render(){
      var app=document.getElementById('app'); if(!app) return;
      var html=''+
      '<div class="header">'+
        '<div style="display:flex;align-items:center;gap:10px"><div class="title">Aclara <span style="color:#F472B6">Admin</span> ‚Äî Compat</div></div>'+
        '<div class="chip">Legacy estable</div>'+
      '</div>'+
      '<div class="row layout-5" style="gap:12px">'+
        '<div class="card"><div class="content">'+
          '<div style="font-weight:700;margin-bottom:6px">Formulario de Pedido</div>'+
          '<div class="row cols-2">'+
            '<div><label class="label">Cliente *</label><input id="lg-nombre" class="input" placeholder="Nombre"/></div>'+
            '<div><label class="label">Tel√©fono</label><input id="lg-tel" class="input" placeholder="829 000 0000"/></div>'+
          '</div>'+
          '<div style="font-weight:700;margin-top:8px">Cat√°logo (opcional)</div>'+
          '<div id="lg-catalog"></div>'+
          '<div><button class="btn" id="lg-cat-add">‚ûï Agregar producto al cat√°logo</button></div>'+
          '<div style="font-weight:700;margin-top:8px">Productos del pedido</div>'+
          '<div id="lg-lines"></div>'+
          '<div><button class="btn" id="lg-line-add">‚ûï Agregar producto</button></div>'+
          '<div style="font-weight:700;margin-top:8px">Couriers</div>'+
          '<div id="lg-couriers"></div>'+
          '<div><button class="btn" id="lg-cour-add">‚ûï Agregar courier</button></div>'+
          '<div class="row cols-2" style="margin-top:6px">'+
            '<div><label class="label">Comprobante de pago (foto)</label><input id="lg-comp" type="file" accept="image/*" class="input"/><div id="lg-comp-prev" style="margin-top:6px"></div></div>'+
            '<div><label class="label">Notas</label><textarea id="lg-notas" class="textarea" rows="3" placeholder="Instrucciones"></textarea></div>'+
          '</div>'+
          '<div id="lg-totales" style="margin-top:8px"></div>'+
          '<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">'+
            '<button class="btn primary" id="lg-guardar">üõí Guardar</button>'+
            '<button class="btn" id="lg-print-a4">üñ®Ô∏è Nota A4</button>'+
            '<button class="btn" id="lg-print-46">üñ®Ô∏è Etiqueta 4√ó6</button>'+
          '</div>'+
        '</div></div>'+
        '<div class="row" style="gap:12px">'+
          '<div class="card"><div class="content">'+
            '<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">Pedidos</div><div><button class="btn" id="lg-export">‚¨áÔ∏è Exportar CSV</button></div></div>'+
            '<div id="lg-list"></div>'+
          '</div></div>'+
          '<div class="card"><div class="content">'+
            '<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">Contabilidad</div><div class="hint">Suma por filtros</div></div>'+
            '<div class="row cols-4">'+
              '<div><label class="label">Desde</label><input id="co-desde" type="date" class="input"/></div>'+
              '<div><label class="label">Hasta</label><input id="co-hasta" type="date" class="input"/></div>'+
              '<div><label class="label">Estado</label><select id="co-estado" class="select">'+['Todos'].concat(STATUS).map(function(s){return '<option>'+s+'</option>';}).join('')+'</select></div>'+
              '<div style="display:flex;align-items:flex-end"><button class="btn" id="co-aplicar">Aplicar</button></div>'+
            '</div>'+
            '<div id="co-cards" class="row cols-3" style="margin-top:8px"></div>'+
            '<div id="co-tabla" style="margin-top:6px"></div>'+
          '</div></div>'+
          '<div class="card"><div class="content">'+
            '<div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">Delivery (Scan)</div><div class="hint">QR/Code39 si el navegador lo soporta</div></div>'+
            '<div class="row"><video id="lg-video" autoplay playsinline style="width:100%;max-height:260px;border-radius:10px;border:1px solid var(--border)"></video>'+ 
            '<div style="display:flex;gap:8px;flex-wrap:wrap"><button class="btn" id="lg-cam-start">üé• Iniciar c√°mara</button><button class="btn" id="lg-cam-stop">‚èπÔ∏è Detener</button><input id="lg-manual" class="input" placeholder="PED-XXXXXX"/><button class="btn" id="lg-ent-cli">‚úÖ Entregado CLIENTE</button><button class="btn" id="lg-ent-cur">üì¶ Entregado COURIER</button></div><div id="lg-last" class="hint"></div></div>'+
          '</div></div>'+
        '</div>'+
      '</div>';
      app.innerHTML=html;

      // ===== Estado temporal del formulario =====
      var catalog=loadCatalog();
      var lines=[{id:uid(), nombre:'', cantidad:1, precio:0, foto:null}];
      var couriers=[{id:uid(), courier:'', sucursal:'', costo:0, cod:false, codMonto:0}];
      var comp=null; // {name,type,size,dataUrl}

      function calcTotales(){ var i,sum=0; for(i=0;i<lines.length;i++){ var l=lines[i]; sum+=Number(l.precio||0)*Number(l.cantidad||0); } var envio=Number(couriers[0]? (couriers[0].costo||0):0); return {subtotal:sum, envio:envio, total:sum+envio}; }
      function findById(arr,id){ for(var i=0;i<arr.length;i++){ if(arr[i].id===id) return arr[i]; } return null; }
      function removeById(arr,id){ for(var i=0;i<arr.length;i++){ if(arr[i].id===id){ arr.splice(i,1); return; } } }

      function renderCatalog(){
        var box=document.getElementById('lg-catalog');
        if(!catalog.length){ box.innerHTML='<div class="hint">Agrega productos al cat√°logo para autocompletar l√≠neas.</div>'; return; }
        var rows='';
        for(var i=0;i<catalog.length;i++){
          var c=catalog[i];
          rows+='<tr data-cid="'+c.id+'"><td>'+imgPreview(c.foto&&c.foto.dataUrl)+'</td><td>'+c.nombre+'</td><td>'+currency(c.precio)+'</td><td><button class="btn red" data-act="cdel">üóëÔ∏è</button></td></tr>';
        }
        box.innerHTML=table(['Foto','Producto','Precio','Acciones'],rows);
        var r=box.querySelectorAll('[data-cid]');
        for(var j=0;j<r.length;j++)(function(row){ var id=row.getAttribute('data-cid'); row.querySelector('[data-act="cdel"]').onclick=function(){ var k=-1; for(var m=0;m<catalog.length;m++){ if(catalog[m].id===id){k=m;break;} } if(k>-1){ catalog.splice(k,1); saveCatalog(catalog); renderCatalog(); }}; })(r[j]);
      }
      function showCatalogForm(){
        var ov=document.createElement('div');
        ov.style.position='fixed'; ov.style.left='0'; ov.style.top='0'; ov.style.right='0'; ov.style.bottom='0'; ov.style.background='rgba(2,6,23,.45)'; ov.style.zIndex='1000';
        ov.innerHTML='<div class="card" style="width:min(560px,94%);margin:40px auto"><div class="content">'+
          '<div class="title" style="font-weight:700">Agregar al cat√°logo</div>'+ 
          '<div class="row cols-2">'+
            '<div><label class="label">Nombre</label><input id="cat-nombre" class="input"/></div>'+ 
            '<div><label class="label">Precio (DOP)</label><input id="cat-precio" type="number" class="input"/></div>'+ 
            '<div><label class="label">Foto</label><input id="cat-foto" type="file" accept="image/*" class="input"/></div>'+ 
            '<div id="cat-prev"></div>'+ 
          '</div>'+ 
          '<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button class="btn" id="cat-cancel">Cancelar</button><button class="btn primary" id="cat-save">Guardar</button></div>'+ 
        '</div></div>';
        document.body.appendChild(ov);
        document.getElementById('cat-cancel').onclick=function(){ document.body.removeChild(ov); };
        document.getElementById('cat-foto').onchange=function(e){ var f=e.target.files[0]; if(!f) return; if(f.size>2*1024*1024){ alert('M√°ximo 2MB'); return; } if(f.type.indexOf('image/')!==0){ alert('Sube una imagen'); return; } fileToDataURL(f,function(u){ document.getElementById('cat-prev').innerHTML='<img src="'+u+'" class="preview-img"/>'; ov._foto={name:f.name,type:f.type,size:f.size,dataUrl:u}; }); };
        document.getElementById('cat-save').onclick=function(){ var nombre=document.getElementById('cat-nombre').value; var precio=Number(document.getElementById('cat-precio').value||0); if(!nombre||!precio){ alert('Nombre y precio requeridos'); return; } var item={id:uid(), nombre:nombre, precio:precio, foto:ov._foto||null}; catalog.unshift(item); saveCatalog(catalog); renderCatalog(); document.body.removeChild(ov); };
        ov.onclick=function(e){ if(e.target===ov){ document.body.removeChild(ov); } };
      }

      function renderLines(){
        var out='';
        for(var i=0;i<lines.length;i++){
          var l=lines[i];
          var catOpts='<option value="">‚Äî Seleccionar del cat√°logo ‚Äî</option>';
          var k; for(k=0;k<catalog.length;k++){ var it=catalog[k]; catOpts+='<option value="'+it.id+'">'+it.nombre+' ‚Äî '+currency(it.precio)+'</option>'; }
          out += ''+
          '<div class="row cols-4" data-line="'+l.id+'">'+
            '<div style="grid-column:1 / span 2"><label class="label">Producto</label><input class="input" data-role="lnombre" value="'+(l.nombre||'')+'"/><div style="margin-top:6px"><select class="select" data-role="lpick">'+catOpts+'</select></div>'+(l.foto&&l.foto.dataUrl?'<div style="margin-top:6px">'+imgPreview(l.foto.dataUrl)+'</div>':'')+'</div>'+
            '<div><label class="label">Cantidad</label><input class="input" type="number" min="1" data-role="lcant" value="'+(l.cantidad||1)+'"/></div>'+
            '<div><label class="label">Precio (DOP)</label><input class="input" type="number" min="0" data-role="lprecio" value="'+(l.precio||0)+'"/></div>'+
            '<div style="grid-column:1 / -1;display:flex;justify-content:flex-end"><button class="btn red" data-role="lrm">Eliminar</button></div>'+
          '</div>';
        }
        document.getElementById('lg-lines').innerHTML=out;
        var boxes=document.querySelectorAll('[data-line]');
        for(var j=0;j<boxes.length;j++)(function(box){
          var id=box.getAttribute('data-line');
          box.querySelector('[data-role="lnombre"]').oninput=function(){ var L=findById(lines,id); L.nombre=this.value; paintTotals(); };
          box.querySelector('[data-role="lcant"]').oninput=function(){ var L=findById(lines,id); L.cantidad=Number(this.value||1); paintTotals(); };
          box.querySelector('[data-role="lprecio"]').oninput=function(){ var L=findById(lines,id); L.precio=Number(this.value||0); paintTotals(); };
          box.querySelector('[data-role="lrm"]').onclick=function(){ if(lines.length>1){ removeById(lines,id); renderLines(); paintTotals(); } };
          var picker=box.querySelector('[data-role="lpick"]'); picker.onchange=function(){ var cid=this.value; if(!cid) return; var it=findById(catalog,cid); if(!it) return; var L=findById(lines,id); L.nombre=it.nombre; L.precio=Number(it.precio||0); L.foto=it.foto||null; renderLines(); paintTotals(); };
        })(boxes[j]);
      }

      function renderCouriers(){
        var out='';
        for(var i=0;i<couriers.length;i++){
          var c=couriers[i];
          out += ''+
          '<div class="row cols-4" data-cour="'+c.id+'" style="border:1px solid var(--border);border-radius:10px;padding:10px">'+
            '<div><label class="label">Courier</label><select class="select" data-role="cname">'+
              ['','MetroPac','BM Cargo','Vimenpaq','PickNDrop','UPS','FedEx','DHL','INPOSDOM','Otro'].map(function(o){return '<option'+(o===c.courier?' selected':'')+'>'+o+'</option>';}).join('')+
            '</select></div>'+
            '<div><label class="label">Sucursal</label><input class="input" data-role="csuc" value="'+(c.sucursal||'')+'" placeholder="Ej: Plaza Central"/></div>'+
            '<div><label class="label">Costo env√≠o (DOP)</label><input class="input" type="number" data-role="ccosto" value="'+(c.costo||0)+'"/></div>'+
            '<div><label class="label">COD</label><div style="display:flex;gap:6px"><input type="checkbox" data-role="ccod"'+(c.cod?' checked':'')+'/><input class="input" type="number" data-role="ccodm" value="'+(c.codMonto||0)+'"'+(c.cod?'':' disabled')+' placeholder="Monto COD"/></div></div>'+
            '<div style="grid-column:1 / -1;display:flex;justify-content:flex-end">'+(i>0?'<button class="btn red" data-role="crm">Eliminar courier</button>':'')+'</div>'+
            (i===0?'<div class="hint" style="grid-column:1 / -1">El primero es <b>principal</b> para etiqueta 4√ó6 y total de env√≠o.</div>':'')+
          '</div>';
        }
        document.getElementById('lg-couriers').innerHTML=out;
        var boxes=document.querySelectorAll('[data-cour]');
        for(var j=0;j<boxes.length;j++)(function(box){
          var id=box.getAttribute('data-cour'); var C=findById(couriers,id);
          box.querySelector('[data-role="cname"]').onchange=function(){ C.courier=this.value; };
          box.querySelector('[data-role="csuc"]').oninput=function(){ C.sucursal=this.value; };
          box.querySelector('[data-role="ccosto"]').oninput=function(){ C.costo=Number(this.value||0); paintTotals(); };
          var cod=box.querySelector('[data-role="ccod"]'); var codm=box.querySelector('[data-role="ccodm"]');
          cod.onchange=function(){ C.cod=!!cod.checked; codm.disabled=!C.cod; };
          codm.oninput=function(){ C.codMonto=Number(this.value||0); };
          var rmb=box.querySelector('[data-role="crm"]'); if(rmb){ rmb.onclick=function(){ if(couriers.length>1){ removeById(couriers,id); renderCouriers(); paintTotals(); } }; }
        })(boxes[j]);
      }

      function paintTotals(){ var t=calcTotales(); document.getElementById('lg-totales').innerHTML='<div class="hint">Subtotal</div><div style="font-weight:700">'+currency(t.subtotal)+'</div><div class="hint">Env√≠o</div><div style="font-weight:700">'+currency(t.envio)+'</div><div class="hint">Total</div><div style="font-weight:800">'+currency(t.total)+'</div>'; }

      // ===== Lista de pedidos =====
      var list=load();
      function paintList(){
        var box=document.getElementById('lg-list');
        if(!list.length){ box.innerHTML='<div class="hint">A√∫n no hay pedidos.</div>'; return; }
        var rows='';
        for(var i=0;i<list.length;i++){
          var p=list[i];
          var labelCourier=(p.envio && p.envio.couriers && p.envio.couriers.length)?(p.envio.couriers[0].courier+(p.envio.couriers[0].sucursal?(' ‚Äî '+p.envio.couriers[0].sucursal):'')):'‚Äî';
          rows+='<tr data-pid="'+p.id+'">'+
            '<td><b>'+p.codigo+'</b><div class="hint">'+new Date(p.fecha).toLocaleString('es-DO')+'</div></td>'+
            '<td>'+p.cliente.nombre+'<div class="hint">'+(p.cliente.telefono||'')+'</div></td>'+
            '<td class="hint">'+labelCourier+'</td>'+
            '<td>'+currency(p.total)+'</td>'+
            '<td><select class="select" data-role="estado">'+STATUS.map(function(s){return '<option'+(s===p.estado?' selected':'')+'>'+s+'</option>';}).join('')+'</select></td>'+
            '<td><div style="display:flex;gap:6px;flex-wrap:wrap">'+
              '<button class="btn" data-act="proc">‚úÖ</button>'+ 
              '<button class="btn" data-act="env">üöö</button>'+ 
              '<button class="btn" data-act="a4">üñ®Ô∏è A4</button>'+ 
              '<button class="btn" data-act="l46">üñ®Ô∏è 4√ó6</button>'+ 
              '<button class="btn red" data-act="del">üóëÔ∏è</button>'+ 
            '</div></td>'+
          '</tr>';
        }
        box.innerHTML=table(['C√≥digo','Cliente','Courier','Total','Estado','Acciones'],rows);
        var rowsEls=box.querySelectorAll('[data-pid]');
        for(var j=0;j<rowsEls.length;j++)(function(row){
          var id=row.getAttribute('data-pid');
          row.querySelector('[data-role="estado"]').onchange=function(){ var P=findById(list,id); if(P){ P.estado=this.value; save(list); }};
          row.querySelector('[data-act="proc"]').onclick=function(){ var P=findById(list,id); if(P){ P.estado='Procesado'; save(list); paintList(); }};
          row.querySelector('[data-act="env"]').onclick=function(){ var P=findById(list,id); if(P){ P.estado='Enviado'; save(list); paintList(); }};
          row.querySelector('[data-act="a4"]').onclick=function(){ var P=findById(list,id); if(P){ legacyPrintA4(P); }};
          row.querySelector('[data-act="l46"]').onclick=function(){ var P=findById(list,id); if(P){ legacyPrint46(P); }};
          row.querySelector('[data-act="del"]').onclick=function(){ var idx=-1; for(var k=0;k<list.length;k++){ if(list[k].id===id){ idx=k; break; } } if(idx>-1){ list.splice(idx,1); save(list); paintList(); }};
        })(rowsEls[j]);
      }

      // ===== Contabilidad =====
      function calcularContabilidad(f){
        var desde=f.desde? new Date(f.desde+'T00:00:00'):null;
        var hasta=f.hasta? new Date(f.hasta+'T23:59:59'):null;
        var estado=f.estado||'Todos';
        var rows=[]; var i;
        for(i=0;i<list.length;i++){
          var p=list[i]; var d=new Date(p.fecha);
          if(desde && d<desde) continue; if(hasta && d>hasta) continue; if(estado!=='Todos' && p.estado!==estado) continue; rows.push(p);
        }
        var subtotal=0, envio=0, total=0, cod=0;
        for(i=0;i<rows.length;i++){
          var r=rows[i]; subtotal+=Number(r.subtotal||0); envio+=Number(r.envio ? r.envio.costo : 0); total+=Number(r.total||0);
          var first=(r.envio && r.envio.couriers && r.envio.couriers[0])? r.envio.couriers[0]:null; if(first && first.cod){ cod+=Number(first.codMonto||r.total); }
        }
        var promedio=rows.length? total/rows.length:0;
        return {rows:rows, resumen:{subtotal:subtotal, envio:envio, total:total, cod:cod, promedio:promedio, conteo:rows.length}};
      }
      function paintConta(){
        var f={ desde:(document.getElementById('co-desde').value||''), hasta:(document.getElementById('co-hasta').value||''), estado:(document.getElementById('co-estado').value||'Todos') };
        var R=calcularContabilidad(f);
        var cards='';
        function card(t,v,d){ return '<div class="card"><div class="content"><div class="hint">'+t+'</div><div style="font-weight:800;font-size:18px">'+v+'</div><div class="hint">'+(d||'')+'</div></div></div>'; }
        cards += card('Total vendido', currency(R.resumen.total));
        cards += card('Subtotal', currency(R.resumen.subtotal));
        cards += card('Env√≠o', currency(R.resumen.envio));
        cards += card('COD a cobrar', currency(R.resumen.cod));
        cards += card('Pedidos', R.resumen.conteo);
        cards += card('Ticket promedio', currency(R.resumen.promedio));
        document.getElementById('co-cards').innerHTML=cards;
        var body=''; for(var i=0;i<R.rows.length;i++){ var p=R.rows[i]; body+='<tr><td>'+p.codigo+'</td><td>'+new Date(p.fecha).toLocaleString('es-DO')+'</td><td>'+p.cliente.nombre+'</td><td>'+p.estado+'</td><td style="text-align:right">'+currency(p.total)+'</td></tr>'; }
        document.getElementById('co-tabla').innerHTML=table(['C√≥digo','Fecha','Cliente','Estado','Total'],body);
      }

      // ===== Delivery Scan =====
      var stream=null, detector=null, lastCode='';
      function stopCam(){ try{ if(stream){ var tr=stream.getTracks(); for(var i=0;i<tr.length;i++){ tr[i].stop(); } } }catch(e){} }
      function parseCode(raw){ if(!raw){return '';} raw=String(raw); try{ var a=document.createElement('a'); a.href=raw; var qs=a.search||''; var m=qs.match(/code=([^&]+)/); if(m){ return decodeURIComponent(m[1]); } if(a.hash){ return a.hash.replace('#',''); } }catch(e){} return raw; }
      function processDelivery(code,dest){ var P=null; for(var i=0;i<list.length;i++){ if(list[i].codigo===code || list[i].id===code){ P=list[i]; break; } } if(!P){ alert('Pedido no encontrado: '+code); return; } P.estado='Entregado'; save(list); paintList(); var last=document.getElementById('lg-last'); last.innerHTML='√öltimo: <b>'+P.codigo+'</b> ‚Üí Entregado a <b>'+dest+'</b> ('+new Date().toLocaleString('es-DO')+')'; }

      // ===== Bind =====
      document.getElementById('lg-cat-add').onclick=showCatalogForm;
      document.getElementById('lg-line-add').onclick=function(){ lines.push({id:uid(), nombre:'', cantidad:1, precio:0, foto:null}); renderLines(); paintTotals(); };
      document.getElementById('lg-cour-add').onclick=function(){ couriers.push({id:uid(), courier:'', sucursal:'', costo:0, cod:false, codMonto:0}); renderCouriers(); paintTotals(); };
      document.getElementById('lg-comp').onchange=function(e){ var f=e.target.files[0]; if(!f){ comp=null; document.getElementById('lg-comp-prev').innerHTML=''; return; } if(f.size>2*1024*1024){ alert('M√°ximo 2MB'); return; } if(f.type.indexOf('image/')!==0){ alert('Sube una imagen'); return; } fileToDataURL(f,function(u){ comp={name:f.name,type:f.type,size:f.size,dataUrl:u}; document.getElementById('lg-comp-prev').innerHTML='<img src="'+u+'" style="max-height:140px;border:1px solid #e5e7eb;border-radius:10px"/>'; }); };

      function buildPedidoFromForm(){ var nombre=document.getElementById('lg-nombre').value; if(!nombre){ alert('Cliente es obligatorio'); return null; } var tel=document.getElementById('lg-tel').value; var t=calcTotales(); var items=[]; for(var i=0;i<lines.length;i++){ items.push({ nombre:lines[i].nombre, cantidad:Number(lines[i].cantidad||0), precio:Number(lines[i].precio||0) }); }
        var p={ id:uid(), codigo:'PED-'+Date.now().toString().slice(-6), fecha:new Date().toISOString(), cliente:{nombre:nombre, telefono:tel}, envio:{ modalidad:'Legacy', couriers:couriers.slice(), costo:t.envio }, items:items, subtotal:t.subtotal, total:t.total, comprobante:comp, notas:document.getElementById('lg-notas').value, estado:'Nuevo' }; return p; }

      document.getElementById('lg-guardar').onclick=function(){ var p=buildPedidoFromForm(); if(!p) return; list.unshift(p); save(list); paintList(); alert('Guardado: '+p.codigo); };
      document.getElementById('lg-print-a4').onclick=function(){ var p=buildPedidoFromForm(); if(!p) return; legacyPrintA4(p); };
      document.getElementById('lg-print-46').onclick=function(){ var p=buildPedidoFromForm(); if(!p) return; legacyPrint46(p); };

      document.getElementById('lg-export').onclick=function(){ if(!list.length) return; var head=['codigo','fecha','cliente','telefono','modalidad','courier','sucursal','envio_costo','subtotal','total','estado','cod','cod_monto','tiene_comprobante']; var out=[head.join(',')]; for(var i=0;i<list.length;i++){ var p=list[i]; var f=(p.envio&&p.envio.couriers&&p.envio.couriers[0])?p.envio.couriers[0]:null; var row=[ p.codigo, new Date(p.fecha).toLocaleString('es-DO'), p.cliente.nombre, (p.cliente.telefono||''), (p.envio?p.envio.modalidad:''), (f?f.courier:''), (f?f.sucursal:''), (p.envio ? p.envio.costo : 0), (p.subtotal||0), (p.total||0), p.estado, (f&&f.cod?'Si':'No'), (f&&f.cod?(f.codMonto||p.total):0), (p.comprobante&&p.comprobante.dataUrl?'Si':'No') ]; for(var j=0;j<row.length;j++){ row[j]='"'+String(row[j]).replace(/"/g,'""')+'"'; } out.push(row.join('\n').replace(/\n/g,' ')); } var blob=new Blob([out.join('\n')],{type:'text/csv;charset=utf-8;'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='pedidos_legacy.csv'; a.click(); setTimeout(function(){URL.revokeObjectURL(url);},3000); };

      document.getElementById('co-aplicar').onclick=paintConta;

      document.getElementById('lg-ent-cli').onclick=function(){ var code=parseCode(document.getElementById('lg-manual').value); if(!code){ alert('Ingresa c√≥digo'); return;} processDelivery(code,'CLIENTE'); };
      document.getElementById('lg-ent-cur').onclick=function(){ var code=parseCode(document.getElementById('lg-manual').value); if(!code){ alert('Ingresa c√≥digo'); return;} processDelivery(code,'COURIER'); };
      document.getElementById('lg-cam-stop').onclick=stopCam;
      document.getElementById('lg-cam-start').onclick=function(){ try{ if(!('BarcodeDetector' in window)){ alert('Lector no soportado en este navegador. Usa el campo manual.'); return; } detector=new BarcodeDetector({formats:['qr_code','code_128','code_39','ean_13','ean_8','upc_a']}); navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(function(s){ stream=s; var v=document.getElementById('lg-video'); v.srcObject=s; (function scan(){ if(!detector||!v.srcObject){return;} detector.detect(v).then(function(bc){ if(bc && bc.length){ var raw=bc[0].rawValue||''; if(raw && raw!==lastCode){ lastCode=raw; var code=parseCode(raw); document.getElementById('lg-manual').value=code; } } if(v.srcObject){ window.requestAnimationFrame(scan); } }); })(); }).catch(function(){ alert('No se pudo iniciar la c√°mara.'); }); }catch(e){ alert('Este navegador no soporta lector. Usa el campo manual.'); } };

      // Pintar todo
      renderCatalog(); renderLines(); renderCouriers(); paintTotals(); paintList(); paintConta();
    }

    // ===== Impresiones (4√ó6 y A4) =====
    function countItems(items){ var n=0; if(items){ for(var i=0;i<items.length;i++){ n+=Number(items[i].cantidad||0); } } return n; }
    function legacyPrint46(p){ var primary=(p.envio&&p.envio.couriers&&p.envio.couriers.length)?p.envio.couriers[0]:{}; var svg=toCode39SVG(p.codigo,4,9,220); var html="<!doctype html><html><head><meta charset='utf-8'><title>Etiqueta "+p.codigo+"</title><style>@page{size:4in 6in;margin:.15in}body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:.05in;font-size:16px}.big{font-size:32px;font-weight:800;letter-spacing:.5px}.mid{font-size:20px;font-weight:bold}.small{font-size:16px}.box{border:2px solid #000;padding:10px;margin:10px 0;border-radius:6px}.hr{border-top:2px dashed #000;margin:10px 0}.mono{font-family:monospace;letter-spacing:.5px}.code{text-align:center;margin-top:12px}</style></head><body>"+
      "<div class='big'>ACLARA</div>"+
      "<div class='small'>"+(new Date(p.fecha).toLocaleDateString('es-DO'))+"</div>"+
      "<div class='box'><div class='mid'><b>DE:</b> Aclara Natural Glow</div><div class='small'>www.cremaaclara.com</div></div>"+
      "<div class='box'><div class='mid'><b>PARA:</b> "+p.cliente.nombre+"</div><div class='small'>"+(p.cliente.telefono||'')+"</div></div>"+
      "<div class='box'><div class='mid'><b>COURIER:</b> <span class='mono'>"+(primary.courier||'')+"</span></div><div class='small'><b>Sucursal:</b> <span class='mono'>"+(primary.sucursal||'')+"</span></div>"+
      (primary.cod?"<div class='small'><b>COD:</b> "+currency(primary.codMonto||p.total)+"</div>":"")+
      "</div>"+
      "<div class='hr'></div><div class='mid'><b>Pedido:</b> <span class='mono'>"+p.codigo+"</span> ‚Ä¢ <b>√çtems:</b> "+countItems(p.items)+"</div>"+
      "<div class='small'>Subtotal: "+currency(p.subtotal||0)+" ‚Ä¢ Env√≠o: "+currency(p.envio ? p.envio.costo : 0)+" ‚Ä¢ Total: "+currency(p.total||0)+"</div>"+
      "<div class='hr'></div><div class='code'>"+svg+"</div>"+
      "<script>window.onload=function(){window.print();};<\/script></body></html>"; openHTML(html); }

    function legacyPrintA4(p){ var cour=p.envio&&p.envio.couriers?p.envio.couriers:[]; var courList=cour.length?('<ul style=\'margin:6px 0 0 18px\'>'+cour.map(function(c){return '<li>'+[c.courier,c.sucursal].filter(Boolean).join(' ‚Äî ')+(c.cod?(' (COD: '+currency(c.codMonto||p.total)+')'):'')+(typeof c.costo==='number'?(' ¬∑ Env√≠o: '+currency(c.costo)):'')+'</li>';}).join('')+'</ul>'):'<div>‚Äî</div>'; var comp=p.comprobante&&p.comprobante.dataUrl?('<div style=\'margin-top:10px\'><div style=\'font-weight:600;margin-bottom:4px\'>Comprobante</div><img src=\''+p.comprobante.dataUrl+'\' style=\'max-width:360px;border:1px solid #ddd;border-radius:8px\'/></div>'):''; var itemsBody=''; var i; for(i=0;i<(p.items||[]).length;i++){ var it=p.items[i]; itemsBody+='<tr><td>'+it.nombre+'</td><td>'+it.cantidad+'</td><td style="text-align:right">'+currency(it.precio)+'</td><td style="text-align:right">'+currency(it.precio*it.cantidad)+'</td></tr>'; } var html="<!doctype html><html><head><meta charset='utf-8'><title>Pedido "+p.codigo+"</title><style>@page{size:A4;margin:18mm}body{font-family:Arial,Helvetica,sans-serif;color:#111}h1{font-size:22px;margin:0 0 6px}h2{font-size:16px;margin:14px 0 6px}table{width:100%;border-collapse:collapse;margin-top:8px}th,td{border-bottom:1px solid #e5e7eb;padding:8px;text-align:left}th{background:#fafafa}.right{text-align:right}</style></head><body>"+
      "<h1>Aclara Natural Glow ‚Äî Pedido "+p.codigo+"</h1>"+
      "<div>Fecha: "+(new Date(p.fecha).toLocaleString('es-DO'))+"</div>"+
      "<h2>Cliente</h2><div><b>"+p.cliente.nombre+"</b></div><div>"+(p.cliente.telefono||'')+"</div>"+
      "<h2>Env√≠o / Courier</h2><div><b>Modalidad:</b> "+(p.envio? p.envio.modalidad : '')+"</div>"+courList+
      "<h2>Productos</h2><table><thead><tr><th>Producto</th><th>Cant.</th><th class='right'>Precio</th><th class='right'>Total</th></tr></thead><tbody>"+itemsBody+"</tbody></table>"+
      "<h2>Resumen</h2><div style='display:grid;grid-template-columns:1fr auto;gap:4px'><div>Subtotal</div><div class='right'>"+currency(p.subtotal||0)+"</div><div>Env√≠o (principal)</div><div class='right'>"+currency(p.envio ? p.envio.costo : 0)+"</div><div style='font-weight:700'>Total</div><div class='right' style='font-weight:700'>"+currency(p.total||0)+"</div></div>"+
      comp+
      "<h2>Notas</h2><div>"+(p.notas||'‚Äî')+"</div><div style='margin-top:10px' class='hint'>Estado: "+p.estado+"</div>"+
      "<script>window.onload=function(){window.print();};<\/script></body></html>"; openHTML(html); }

    // ===== Boot =====
    document.addEventListener('DOMContentLoaded', function(){
      try{ render(); }catch(e){
        var app=document.getElementById('app'); if(app){ app.innerHTML='<div class="card"><div class="content"><div class="title">Error al cargar</div><div class="hint">'+(e&&e.message? e.message : 'Error desconocido')+'</div></div></div>'; }
        console.error('Init error', e);
      }
    });
  }catch(err){
    var app2=document.getElementById('app'); if(app2){ app2.innerHTML='<div class="card"><div class="content"><div class="title">Modo compatibilidad</div><div class="hint">No se pudo iniciar. Dime el primer error de la consola.</div></div></div>'; }
    console.error('Fatal', err);
  }
})();
</script>
</body>
</html>

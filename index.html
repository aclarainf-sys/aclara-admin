<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>Aclara Admin ‚Äî OFFLINE (Legacy estable)</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<meta name="theme-color" content="#F472B6"/>
<style>
  /* ===== Aclara Admin ‚Äî Legacy estable, mobile-first, sin dependencias ===== */
  :root{
    --bg:#FFF6FA; --text:#1F2937; --muted:#6B7280; --border:#F8D7E4; --card:#FFFFFF;
    --primary:#F472B6; --primary-700:#DB2777; --ring:rgba(244,114,182,.35);
    --shadow:0 10px 30px rgba(244,114,182,.08); --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;background:var(--bg);color:var(--text)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
  .title{font-size:22px;font-weight:800}
  .title strong{color:var(--primary)}
  .chip{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#F3F4F6;color:#374151}
  .badge{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#fff}
  .card{border:1px solid var(--border);border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow)}
  .content{padding:14px}
  .btn{display:inline-flex;align-items:center;gap:8px;height:42px;padding:0 14px;font-size:14px;border-radius:12px;border:1px solid var(--border);background:white;color:var(--text);cursor:pointer}
  .btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
  .btn.primary:hover{background:var(--primary-700);border-color:var(--primary-700)}
  .btn.red{background:#dc2626;color:#fff;border-color:#b91c1c}
  .input,.select,.textarea{width:100%;border:1px solid var(--border);border-radius:10px;padding:10px 12px;font-size:14px;background:white}
  .input:focus,.select:focus,.textarea:focus{outline:none;box-shadow:0 0 0 4px var(--ring);border-color:var(--primary)}
  .label{display:block;font-size:12px;color:var(--muted);margin:2px 0 6px}
  .hint{font-size:12px;color:var(--muted)}
  .row{display:grid;gap:10px}
  .tabs{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px;border:1px solid var(--border);border-radius:12px;background:white;padding:6px;box-shadow:var(--shadow)}
  .tab{border-radius:10px;padding:10px 12px;text-align:center;cursor:pointer;font-size:14px;color:#334155}
  .tab.active{background:var(--primary);color:#fff}
  table{width:100%;border-collapse:collapse;font-size:14px}
  th,td{text-align:left;padding:10px;border-bottom:1px solid #EEF2F7;vertical-align:top}
  thead{background:#F9FAFB}
  .preview-img{width:56px;height:56px;border-radius:10px;object-fit:cover;border:1px solid var(--border)}
  .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(2,6,23,.35);z-index:50}
  .dialog{width:min(640px,94%);background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
  .brand-logo{height:36px;width:auto;display:block;border-radius:8px}
  @media(min-width:900px){.row.cols-2{grid-template-columns:1fr 1fr}.row.cols-3{grid-template-columns:1fr 1fr 1fr}.row.cols-4{grid-template-columns:repeat(4,1fr)}.layout-5{grid-template-columns:3fr 2fr}}
  @media(max-width:899px){.row.cols-2,.row.cols-3,.row.cols-4{grid-template-columns:1fr}.btn{height:48px}.card{border-radius:16px}.content{padding:14px}}
</style>
</head>
<body>
<div class="container" id="app"><div style="padding:32px; text-align:center; color:#6b7280">Cargando‚Ä¶</div></div>

<script>(function(){
  // ===== Captura de errores en pantalla (debug r√°pido) =====
  (function(){
    function showErr(msg){
      var box=document.getElementById('err-overlay');
      if(!box){
        box=document.createElement('div');
        box.id='err-overlay';
        box.style.cssText='position:fixed;inset:0;z-index:9999;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;padding:16px';
        var inner=document.createElement('div');
        inner.style.cssText='max-width:800px;width:95%;background:#fff;border:2px solid #ef4444;border-radius:12px;padding:14px;font:14px ui-sans-serif,system-ui;white-space:pre-wrap;max-height:80vh;overflow:auto';
        inner.innerHTML='<div style="font-weight:700;color:#b91c1c;margin-bottom:8px">‚ö†Ô∏è Error de ejecuci√≥n</div><div id="err-msg" style="color:#111"></div><div style="margin-top:10px;text-align:right"><button id="err-close" class="btn" style="background:#ef4444;color:#fff;border-color:#ef4444">Cerrar</button></div>';
        box.appendChild(inner); document.body.appendChild(box);
        document.getElementById('err-close').onclick=function(){ box.remove(); };
      }
      document.getElementById('err-msg').textContent=String(msg||'Error desconocido');
    }
    window.addEventListener('error',function(e){ showErr((e.message||'')+'\n'+(e.filename||'')+':'+(e.lineno||'') ); });
    window.addEventListener('unhandledrejection',function(e){ try{ showErr('Promise no manejada: '+ (e.reason&&e.reason.stack?e.reason.stack:(e.reason||'')).toString()); }catch(_){ showErr('Promise no manejada'); } });
  })();

  // ====== CONSTANTES Y ESTADO ======
  var LS_KEY='aclara-admin-offline-v3';
  var STATUS=['Nuevo','Pagado','Procesado','Empacado','Enviado','Entregado','Cancelado'];
  var state=null; var currentTab='form';
  var contaFiltros={desde:'',hasta:'',estado:'Todos'};

  function currency(n){ n=Number(n||0); try{return new Intl.NumberFormat('es-DO',{style:'currency',currency:'DOP'}).format(n);}catch(e){return 'DOP '+n.toFixed(2);} }
  function uid(){ return Math.random().toString(36).slice(2,9); }

  var LOGO_SVG="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='160' height='40' viewBox='0 0 320 80'><defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop offset='0%' stop-color='%23ff9ecd'/><stop offset='100%' stop-color='%23f472b6'/></linearGradient></defs><rect rx='12' ry='12' width='320' height='80' fill='white'/><circle cx='56' cy='40' r='32' fill='none' stroke='%23f197c6' stroke-width='6'/><text x='96' y='50' font-family='Segoe UI, Roboto, sans-serif' font-size='28' font-weight='700' fill='url(%23g)'>Aclara Admin</text></svg>";

  // ==== Code39 (ES5) ====
  var CODE39={'0':'101001101101','1':'110100101011','2':'101100101011','3':'110110010101','4':'101001101011','5':'110100110101','6':'101100110101','7':'101001011011','8':'110100101101','9':'101100101101','A':'110101001011','B':'101101001011','C':'110110100101','D':'101011001011','E':'110101100101','F':'101101100101','G':'101010011011','H':'110101001101','I':'101101001101','J':'101011001101','K':'110101010011','L':'101101010011','M':'110110101001','N':'101011010011','O':'110101101001','P':'101101101001','Q':'101010110011','R':'110101011001','S':'101101011001','T':'101011011001','U':'110010101011','V':'100110101011','W':'110011010101','X':'100101101011','Y':'110010110101','Z':'100110110101','-':'100101011011','.':'110010101101',' ':'100110101101','*':'100101101101','/':'100101101001','+':'100101001101','%':'101001101001'};
  function toCode39(text){ text='*'+String(text||'').toUpperCase()+'*'; var out=''; for(var i=0;i<text.length;i++){ var ch=text.charAt(i); out+=(CODE39[ch]||CODE39[' '])+'0'; } return out; }
  function makeCode39SVG(bits,narrow,wide,height){ narrow=narrow||2; wide=wide||5; height=height||160; var x=0,bars=[]; for(var i=0;i<bits.length;i++){ var w=(bits.charAt(i)==='1'?wide:narrow); if(i%2===0){ bars.push("<rect x='"+x+"' y='0' width='"+w+"' height='"+height+"'/>"); } x+=w; } return "<svg xmlns='http://www.w3.org/2000/svg' width='"+x+"' height='"+height+"' viewBox='0 0 "+x+" "+height+"' shape-rendering='crispEdges'>"+bars.join('')+"</svg>"; }
  function toCode39SVG(text,narrow,wide,height){ return makeCode39SVG(toCode39(text),narrow,wide,height); }

  // ==== ESTADO POR DEFECTO / STORAGE ====
  function defaultState(){ var adminId=uid(); return { inventario:[ { id:uid(), sku:'ACL-CR-120', nombre:'Crema Aclara 4 oz', precio:1300, stock:25, foto:null }, { id:uid(), sku:'ACL-GL-050', nombre:'Glow Lift 50 ml', precio:2200, stock:12, foto:null }, { id:uid(), sku:'ACL-VC-030', nombre:'S√©rum Vitamina C 30 ml', precio:1600, stock:30, foto:null } ], pedidos:[], usuarios:[{ id:adminId, nombre:'Admin', email:'', rol:'Admin', pin:'0000' }], currentUser:null }; }
  function loadLocal(){ try{ return JSON.parse(localStorage.getItem(LS_KEY))||defaultState(); }catch(e){ return defaultState(); } }
  function saveLocal(){ try{ localStorage.setItem(LS_KEY, JSON.stringify(state)); }catch(e){} }
  function setState(mut){ if(typeof mut==='function'){ state=mut(state)||state; } else { for(var k in mut){ if(mut.hasOwnProperty(k)) state[k]=mut[k]; } }
    saveLocal(); render(); }

  // ==== UTILS DOM ====
  function el(s,r){ return (r||document).querySelector(s); }
  function els(s,r){ return Array.prototype.slice.call((r||document).querySelectorAll(s)); }
  function imgPreview(dataUrl){ return dataUrl?"<img src='"+dataUrl+"' class='preview-img' alt='img'/>":"<div class='preview-img' style='background:#f3f4f6'></div>"; }
  function table(headers, rowsHtml){ var h=''; for(var i=0;i<headers.length;i++){ h+='<th>'+headers[i]+'</th>'; } return "<div class='card'><div class='content' style='padding:0'><table><thead><tr>"+h+"</tr></thead><tbody>"+rowsHtml+"</tbody></table></div></div>"; }
  function exportCSV(rows,filename){ if(!rows||!rows.length) return; var keys=Object.keys(rows[0]); var head=keys.join(','); var body=rows.map(function(r){ return keys.map(function(k){ var v=r[k]; v=String(v).replace(/"/g,'""'); return '"'+v+'"'; }).join(','); }).join('\n'); var blob=new Blob([head+'\n'+body],{type:'text/csv;charset=utf-8;'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }
  function fileToDataURL(file,cb){ var r=new FileReader(); r.onload=function(){ cb(String(r.result)); }; r.onerror=function(){ cb(null); }; r.readAsDataURL(file); }

  // ==== ABRIR HTML (modo seguro y compatibilidad) ====
  function openHTML(html){
    var SAFE=/[?&]safe=1/.test(location.search);
    try{
      if(SAFE){
        // Vista previa integrada (sin pop‚Äëups) usando iframe srcdoc
        var wrap=document.createElement('div');
        wrap.style.cssText='position:fixed;inset:0;background:rgba(2,6,23,.6);z-index:9998;display:flex;align-items:center;justify-content:center;padding:12px';
        var modal=document.createElement('div');
        modal.style.cssText='width:95%;height:90%;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.2);display:flex;flex-direction:column;overflow:hidden;border:1px solid #e5e7eb';
        var bar=document.createElement('div');
        bar.style.cssText='display:flex;gap:8px;justify-content:flex-end;padding:8px;border-bottom:1px solid #e5e7eb;background:#fafafa';
        var btnP=document.createElement('button'); btnP.className='btn'; btnP.textContent='Imprimir'; btnP.onclick=function(){ try{ frame.contentWindow.focus(); frame.contentWindow.print(); }catch(_){ alert('No se pudo imprimir desde el modo seguro'); } };
        var btnC=document.createElement('button'); btnC.className='btn'; btnC.textContent='Cerrar'; btnC.onclick=function(){ wrap.remove(); };
        bar.appendChild(btnP); bar.appendChild(btnC);
        var frame=document.createElement('iframe');
        frame.style.cssText='flex:1;border:0;';
        frame.srcdoc=String(html||'');
        modal.appendChild(bar); modal.appendChild(frame); wrap.appendChild(modal); document.body.appendChild(wrap);
        return 'inline-iframe';
      }
      // 1) Pesta√±a vac√≠a + write (m√°s compatible)
      var w = window.open('', '_blank');
      if(w && w.document){
        try{ w.document.open('text/html','replace'); w.document.write(String(html||'')); w.document.close(); return 'inline-window'; }catch(e){ /* fallback*/ }
      }
      // 2) Blob
      var blob=new Blob([String(html||'')],{type:'text/html;charset=utf-8'});
      var url=URL.createObjectURL(blob);
      var wb=window.open(url,'_blank');
      if(!wb){ alert('El navegador bloque√≥ la ventana emergente. Permite pop‚Äëups para imprimir o usa ?safe=1.'); }
      setTimeout(function(){ URL.revokeObjectURL(url); }, 8000);
      return url;
    }catch(e){ console.warn('openHTML error', e); alert('No se pudo abrir la vista de impresi√≥n.'); }
  }

  // ==== ETIQUETA 4√ó6 (FUENTE 16) ====
  function printLabel4x6(p){
    var primary=(p.envio && p.envio.couriers && p.envio.couriers[0])? p.envio.couriers[0]:{};
    var svg=toCode39SVG(p.codigo,4,9,220);
    var itemsCount=0; if(p.items){ for(var i=0;i<p.items.length;i++){ itemsCount+=Number(p.items[i].cantidad||0); } }
    var subtotal = typeof p.subtotal==='number'? p.subtotal : (Number(p.total||0)-Number(p.envio&&p.envio.costo||0));
    var html='<!doctype html><html><head><meta charset="utf-8"><title>Etiqueta '+p.codigo+'</title>'+
    '<style>@page{size:4in 6in;margin:.15in}body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:.05in;font-size:16px}.wrap{width:100%;height:100%}.row{display:flex;justify-content:space-between;align-items:flex-start}.big{font-size:32px;font-weight:800;letter-spacing:.5px}.mid{font-size:20px;font-weight:700}.small{font-size:16px;color:#111}.box{border:2px solid #000;padding:10px;margin:10px 0;border-radius:6px}.code{text-align:center;margin-top:12px}.hr{border-top:2px dashed #000;margin:10px 0}.mono{font-family:monospace;letter-spacing:.5px}</style></head><body>'+
    '<div class="wrap">'+
      '<div class="row"><div class="big">ACLARA</div><div class="small">'+new Date(p.fecha).toLocaleDateString('es-DO')+'</div></div>'+
      '<div class="box"><div class="mid"><b>DE:</b> Aclara Natural Glow</div><div class="small">www.cremaaclara.com ‚Ä¢ @crema.aclara</div></div>'+
      '<div class="box"><div class="mid"><b>PARA:</b> '+p.cliente.nombre+'</div><div class="small">'+(p.cliente.telefono||'')+'</div></div>'+
      '<div class="box"><div class="mid"><b>COURIER:</b> <span class="mono">'+(primary.courier||'')+'</span></div><div class="small"><b>Sucursal:</b> <span class="mono">'+(primary.sucursal||'')+'</span></div><div class="small"><b>Modalidad:</b> '+(p.envio?p.envio.modalidad:'')+'</div>'+ (primary.cod?('<div class="small"><b>COD:</b> '+currency(primary.codMonto||p.total)+'</div>'):'') + '</div>'+
      '<div class="hr"></div><div class="mid"><b>Pedido:</b> <span class="mono">'+p.codigo+'</span> ‚Ä¢ <b>√çtems:</b> '+itemsCount+'</div>'+
      '<div class="small">Subtotal: '+currency(subtotal)+' ‚Ä¢ Env√≠o: '+currency(p.envio?p.envio.costo:0)+' ‚Ä¢ Total: '+currency(p.total)+'</div>'+
      '<div class="hr"></div><div class="code">'+svg+'</div>'+
    '</div><script>window.onload=function(){window.print();};<\/script></body></html>';
    openHTML(html);
  }

  // ==== NOTA A4 (con foto de comprobante) ====
  function printA4(p){
    var cour=p.envio&&p.envio.couriers?p.envio.couriers:[];
    var courList;
    if(cour.length){
      var items = cour.map(function(c){
        var s = (c.courier||'');
        if(c.sucursal) s += ' ‚Äî ' + c.sucursal;
        if(c.cod) s += ' (COD: '+currency(c.codMonto||p.total)+')';
        if(typeof c.costo==='number') s += ' ¬∑ Env√≠o: '+currency(c.costo);
        return '<li>'+s+'</li>';
      }).join('');
      courList = "<ul style='margin:6px 0 0 18px'>"+items+"</ul>";
    } else {
      courList = '<div>‚Äî</div>';
    }
    var compHtml='';
    if(p.comprobante && p.comprobante.dataUrl){
      compHtml = "<div style='margin-top:10px'><div style='font-weight:600;margin-bottom:4px'>Comprobante</div><img src='"+p.comprobante.dataUrl+"' style='max-width:360px;border:1px solid #ddd;border-radius:8px'/></div>";
    }
    var itemsBody=''; var i; for(i=0;i<(p.items||[]).length;i++){ var it=p.items[i]; itemsBody+='<tr><td>'+it.nombre+'</td><td>'+it.cantidad+'</td><td style="text-align:right">'+currency(it.precio)+'</td><td style="text-align:right">'+currency(it.precio*it.cantidad)+'</td></tr>'; }
    var html='<!doctype html><html><head><meta charset="utf-8"><title>Pedido '+p.codigo+'</title><style>@page{size:A4;margin:18mm}body{font-family:Arial,Helvetica,sans-serif;color:#111}h1{font-size:22px;margin:0 0 6px}h2{font-size:16px;margin:14px 0 6px}table{width:100%;border-collapse:collapse;margin-top:8px}th,td{border-bottom:1px solid #e5e7eb;padding:8px;text-align:left}th{background:#fafafa}.right{text-align:right}</style></head><body>'+
      '<h1>Aclara Natural Glow ‚Äî Pedido '+p.codigo+'</h1>'+
      '<div>Fecha: '+new Date(p.fecha).toLocaleString('es-DO')+'</div>'+
      '<h2>Cliente</h2><div><b>'+p.cliente.nombre+'</b></div><div>'+(p.cliente.telefono||'')+'</div>'+
      '<h2>Env√≠o / Courier</h2><div><b>Modalidad:</b> '+(p.envio?p.envio.modalidad:'')+'</div>'+courList+
      '<h2>Productos</h2><table><thead><tr><th>Producto</th><th>Cant.</th><th class="right">Precio</th><th class="right">Total</th></tr></thead><tbody>'+itemsBody+'</tbody></table>'+
      '<h2>Resumen</h2><div style="display:grid;grid-template-columns:1fr auto;gap:4px"><div>Subtotal</div><div class="right">'+currency(p.subtotal||0)+'</div><div>Env√≠o (principal)</div><div class="right">'+currency(p.envio?p.envio.costo:0)+'</div><div style="font-weight:700">Total</div><div class="right" style="font-weight:700">'+currency(p.total||0)+'</div></div>'+
      compHtml+
      '<h2>Notas</h2><div>'+(p.notas||'‚Äî')+'</div><div style="margin-top:10px" class="hint">Estado: '+p.estado+'</div>'+
      '<script>window.onload=function(){window.print();};<\/script></body></html>';
    openHTML(html);
  }

  // ==== RENDER =====
  function renderHeader(){
    var authed=!!(state&&state.currentUser);
    var modeChip='<span class="chip">'+(authed?'Privado (sesi√≥n)':'P√∫blico')+'</span>';
    return '<div class="header">'+
      '<div style="display:flex; align-items:center; gap:12px">'+
        '<img src="'+LOGO_SVG+'" class="brand-logo" alt="Aclara"/>'+ 
        '<div><div class="title">Aclara <strong>Admin</strong></div><div class="hint">'+(authed?'Secciones internas desbloqueadas.':'Solo el formulario est√° disponible sin iniciar sesi√≥n.')+'</div></div>'+
      '</div>'+
      '<div style="display:flex; align-items:center; gap:8px">'+
        modeChip+
        '<span class="badge">'+(state.currentUser?state.currentUser.rol:'Invitado')+'</span>'+
        '<span class="hint">'+(state.currentUser?state.currentUser.nombre:'Sin sesi√≥n')+'</span>'+
        '<button class="btn" id="btn-login">'+(state.currentUser?'Cambiar usuario':'Iniciar sesi√≥n')+'</button>'+
        (state.currentUser?'<button class="btn" id="btn-logout">Salir</button>':'')+
      '</div></div>';
  }
  function renderTabs(){
    var authed=!!(state&&state.currentUser); var role=(state.currentUser&&state.currentUser.rol)||'Invitado';
    var items=[["form","‚úçÔ∏è Formulario"]];
    if(authed){ items=[["inventario","üì¶ Inventario"],["pedidos","üõí Pedidos"],["clientes","üë• Clientes"]]; if(role==='Admin'){ items.push(["conta","üìä Contabilidad"],["usuarios","üë§ Usuarios"],["scan","üì∑ Escanear"]); } items.push(["form","‚úçÔ∏è Formulario"]); }
    var i,desk='<div class="tabs" style="margin-bottom:12px">'; for(i=0;i<items.length;i++){ var k=items[i][0],l=items[i][1]; desk+='<div class="tab '+(currentTab===k?'active':'')+'" data-tab="'+k+'">'+l+'</div>'; } desk+='</div>'; return desk;
  }

  function renderInventario(){ var canEdit=(state.currentUser&&state.currentUser.rol==='Admin'); var rows=''; for(var i=0;i<state.inventario.length;i++){ var p=state.inventario[i]; rows+='<tr>'+ '<td>'+imgPreview(p.foto&&p.foto.dataUrl)+'</td>'+'<td class="hint">'+(p.sku||'‚Äî')+'</td>'+'<td>'+p.nombre+'</td>'+'<td>'+currency(p.precio)+'</td>'+'<td>'+p.stock+'</td>'+'<td><div class="toolbar">'+ '<button class="btn" '+(canEdit?'':'disabled')+' data-act="edit-product" data-id="'+p.id+'">‚úèÔ∏è Editar</button>'+ '<button class="btn red" '+(canEdit?'':'disabled')+' data-act="del-product" data-id="'+p.id+'">üóëÔ∏è Eliminar</button>'+ '</div></td></tr>'; } return '<div class="row" style="gap:16px">'+ '<div class="toolbar"><span class="hint">Productos totales: <b>'+state.inventario.length+'</b></span> <button class="btn primary" '+(canEdit?'':'disabled')+' id="btn-new-product">‚ûï Nuevo producto</button></div>'+ table(['Foto','SKU','Producto','Precio','Stock','Acciones'],rows) +'</div>'; }

  function showProductoForm(editId){ var p=null; for(var i=0;i<state.inventario.length;i++){ if(state.inventario[i].id===editId){ p=state.inventario[i]; break; } } if(!p){ p={ sku:'', nombre:'', precio:'', stock:'', foto:null }; }
    var html='<div class="overlay" id="inv-ov"><div class="dialog"><div class="content">'+ '<div class="title">'+(editId?'Editar':'Agregar')+' producto</div>'+ '<div class="row cols-2">'+ '<div><label class="label">SKU</label><input id="p-sku" class="input" value="'+(p.sku||'')+'"/></div>'+ '<div><label class="label">Nombre</label><input id="p-nombre" class="input" value="'+(p.nombre||'')+'"/></div>'+ '<div><label class="label">Precio (DOP)</label><input id="p-precio" type="number" class="input" value="'+(p.precio||'')+'"/></div>'+ '<div><label class="label">Stock</label><input id="p-stock" type="number" class="input" value="'+(p.stock||0)+'"/></div>'+ '<div><label class="label">Foto del producto</label><input id="p-foto" type="file" accept="image/*" class="input"/></div>'+ (p.foto&&p.foto.dataUrl?('<div><img src="'+p.foto.dataUrl+'" class="preview-img"/></div>'):'')+ '</div>'+ '<div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button class="btn" id="p-cancel">Cancelar</button><button class="btn primary" id="p-save">Guardar</button></div>'+ '</div></div></div>';
    document.body.insertAdjacentHTML('beforeend', html);
    var ov=el('#inv-ov'); el('#p-cancel',ov).onclick=function(){ ov.remove(); };
    el('#p-save',ov).onclick=function(){ var sku=el('#p-sku',ov).value.trim(); var nombre=el('#p-nombre',ov).value.trim(); var precio=Number(el('#p-precio',ov).value||0); var stock=Number(el('#p-stock',ov).value||0); var foto=p.foto||null; var file=el('#p-foto',ov).files[0]; if(file){ if(file.type.indexOf('image/')!==0){ alert('Sube una imagen'); return; } if(file.size>2*1024*1024){ alert('M√°x 2MB'); return; } fileToDataURL(file,function(u){ foto={name:file.name,type:file.type,size:file.size,dataUrl:u}; finalize(); }); } else { finalize(); }
      function finalize(){ if(!nombre||!precio){ alert('Completa nombre y precio'); return; } setState(function(s){ var inv=s.inventario.slice(); if(editId){ for(var i=0;i<inv.length;i++){ if(inv[i].id===editId){ inv[i]={id:inv[i].id, sku:sku, nombre:nombre, precio:precio, stock:stock, foto:foto}; break; } } } else { inv.unshift({id:uid(), sku:sku, nombre:nombre, precio:precio, stock:stock, foto:foto}); } return {inventario:inv}; }); ov.remove(); }
    };
    ov.addEventListener('click', function(e){ if(e.target===ov){ ov.remove(); } });
  }

  function renderForm(){ return "<form id='order-form' class='row' style='gap:12px'>"+
    "<div class='card'><div class='content'>"+
      "<div style='font-weight:600;font-size:15px;margin-bottom:6px'>Informaci√≥n del Cliente</div>"+
      "<div class='row cols-2'>"+
        "<div><label class='label'>Nombre *</label><input name='c-nombre' class='input' placeholder='Nombre y Apellido' autocomplete='name' /></div>"+
        "<div><label class='label'>Tel√©fono</label><input name='c-telefono' class='input' placeholder='829 000 0000' inputmode='tel' autocomplete='tel' /></div>"+
        "<div><label class='label'>Modalidad</label><select name='env-modalidad' class='select'><option>Retiro en establecimiento</option><option>Env√≠o a domicilio</option></select></div>"+
      "</div>"+
      "<div style='margin-top:10px; font-weight:600; font-size:14px'>Couriers (puedes agregar varios)</div>"+
      "<div id='couriers'></div>"+
      "<div style='margin-top:8px'><button class='btn' type='button' id='courier-add'>‚ûï Agregar courier</button></div>"+
    "</div></div>"+
    "<div class='card'><div class='content'>"+
      "<div style='display:flex; align-items:center; justify-content:space-between'><div style='font-weight:600; font-size:15px'>Productos</div><button class='btn' type='button' id='line-add'>‚ûï Agregar l√≠nea</button></div>"+
      "<div id='lines' class='row' style='gap:10px; margin-top:6px'></div>"+
      "<div class='row cols-2' style='margin-top:6px'><div><label class='label'>Comprobante de pago (foto)</label><input id='comp-file' type='file' accept='image/*' class='input'/><div id='comp-preview' style='margin-top:8px'></div></div><div><label class='label'>Notas</label><textarea id='order-notas' class='textarea' placeholder='Instrucciones de env√≠o, referencia, etc.' rows='3'></textarea></div></div>"+
      "<div class='sticky-total'><div id='totales' style='display:grid; gap:8px; margin-top:8px'></div><div class='sticky-actions'><button class='btn' type='button' id='a4-preview'>üñ®Ô∏è Vista previa A4</button><button class='btn primary' type='submit' style='min-width:180px'>üõí Guardar Pedido</button></div></div>"+
    "</div></div>"+
  "</form>"; }

  function calcTotales(lines, primaryCosto){ var subtotal=0,i; for(i=0;i<lines.length;i++){ var l=lines[i]; subtotal+=Number(l.precio||0)*Number(l.cantidad||0); } var envio=Number(primaryCosto||0); return { subtotal:subtotal, envio:envio, total:subtotal+envio }; }
  function renderLines(lines){ var productos=state.inventario; var out=''; for(var i=0;i<lines.length;i++){ var l=lines[i]; var prod=null,j; for(j=0;j<productos.length;j++){ if(productos[j].id===l.productoId){ prod=productos[j]; break; } } var fotoHtml=(prod && prod.foto && prod.foto.dataUrl)? "<div style='margin-top:6px'><img src='"+prod.foto.dataUrl+"' class='preview-img'/></div>":""; out+="<div class='row cols-4' style='align-items:end' data-line='"+l.id+"'>"+
    "<div style='grid-column:1 / span 2'><label class='label'>Producto</label><select class='select' data-role='prod'>"+ productos.map(function(p){ return "<option value='"+p.id+"' "+(p.id===l.productoId?'selected':'')+">"+p.nombre+" ‚Äî "+currency(p.precio)+"</option>"; }).join('') +"</select>"+ fotoHtml +"</div>"+
    "<div><label class='label'>Cantidad</label><input class='input' type='number' min='1' value='"+(l.cantidad||1)+"' data-role='cant'/></div>"+
    "<div style='display:flex; align-items:center'><button class='btn red' type='button' data-role='rm'>üóëÔ∏è Quitar</button></div>"+
  "</div>"; } return out; }
  function renderCouriers(cs){ var out=''; for(var i=0;i<cs.length;i++){ var c=cs[i]; out += "<div class='row cols-4' style='align-items:end;border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:8px' data-courier='"+c.id+"'>"+
    "<div><label class='label'>Courier</label><select class='select' data-role='courier'>"+['','MetroPac','BM Cargo','Vimenpaq','PickNDrop','UPS','FedEx','DHL','INPOSDOM','Otro'].map(function(o){ return '<option '+(o===c.courier?'selected':'')+'>'+o+'</option>'; }).join('')+"</select></div>"+
    "<div><label class='label'>Establecimiento / Sucursal</label><input class='input' data-role='sucursal' value='"+(c.sucursal||'')+"' placeholder='Ej: MetroPac - Plaza Central'/></div>"+
    "<div><label class='label'>Costo de Env√≠o (DOP)</label><input class='input' type='number' data-role='costo' value='"+(c.costo||0)+"' placeholder='0'/></div>"+
    "<div><label class='label'>Pago contra entrega (COD)</label><div style='display:flex; gap:8px'><input type='checkbox' data-role='cod' "+(c.cod?'checked':'')+"/><input type='number' class='input' style='flex:1' data-role='codm' value='"+(c.codMonto||0)+"' "+(c.cod?'':'disabled')+" placeholder='Monto COD'/></div></div>"+
    "<div style='grid-column:1 / -1; display:flex; justify-content:flex-end'>"+(i>0?"<button class='btn red' type='button' data-role='rmc'>Eliminar courier</button>":'')+"</div>"+
    (i===0?"<div class='hint' style='grid-column:1 / -1'>El primer courier se considera <b>principal</b> para calcular env√≠o del total e imprimir la etiqueta.</div>":'')+
  "</div>"; } return out; }

  function renderPedidos(){ var rows=''; for(var i=0;i<state.pedidos.length;i++){ var p=state.pedidos[i]; var n=(p.envio&&p.envio.couriers&&p.envio.couriers.length)||0; var f=(p.envio&&p.envio.couriers&&p.envio.couriers[0])||null; var label=f?(f.courier+(f.sucursal?(' ‚Äî '+f.sucursal):'')+(n>1?(' (+'+(n-1)+')'):'') ):'‚Äî'; rows+='<tr data-pid="'+p.id+'"><td><b>'+p.codigo+'</b></td><td class="hint">'+new Date(p.fecha).toLocaleString('es-DO')+'</td><td>'+p.cliente.nombre+'</td><td class="hint">'+label+'</td><td>'+currency(p.total)+'</td><td><select class="select" data-role="estado">'+STATUS.map(function(s){return '<option '+(s===p.estado?'selected':'')+'>'+s+'</option>';}).join('')+'</select></td><td><div class="toolbar"><button class="btn" data-act="proc">‚úÖ Procesado</button><button class="btn" data-act="env">üöö Enviado</button><button class="btn" data-act="nota">üñ®Ô∏è Nota A4</button><button class="btn" data-act="label">üñ®Ô∏è Etiqueta 4√ó6</button><button class="btn red" data-act="del" '+(state.currentUser&&state.currentUser.rol==='Admin'?'':'disabled')+'>üóëÔ∏è Borrar</button></div></td></tr>'; }
    return '<div class="row" style="gap:16px"><div class="toolbar"><span class="hint">Pedidos: <b>'+state.pedidos.length+'</b></span> <button class="btn" id="ped-export">‚¨áÔ∏è Exportar CSV</button></div>'+ table(['C√≥digo','Fecha','Cliente','Courier','Total','Estado','Acciones'], rows) +'</div>'; }

  function renderClientes(){ var map={}; for(var i=0;i<state.pedidos.length;i++){ var p=state.pedidos[i]; var key=(p.cliente.telefono||p.cliente.nombre)||p.cliente.nombre; if(!map[key]) map[key]={nombre:p.cliente.nombre, telefono:p.cliente.telefono||'', pedidos:0, total:0}; map[key].pedidos+=1; map[key].total+=p.total; } var list=[]; for(var k in map){ list.push(map[k]); } list.sort(function(a,b){ return b.total-a.total; }); var rows=''; for(var j=0;j<list.length;j++){ var c=list[j]; rows+='<tr><td>'+c.nombre+'</td><td class="hint">'+(c.telefono||'‚Äî')+'</td><td>'+c.pedidos+'</td><td>'+currency(c.total)+'</td></tr>'; } return '<div class="row" style="gap:16px"><div class="toolbar"><button class="btn" id="cli-export">‚¨áÔ∏è Exportar CSV</button></div>'+ table(['Cliente','Tel√©fono','Pedidos','Total'], rows) +'</div>'; }

  function renderUsuarios(){ var isAdmin=(state.currentUser&&state.currentUser.rol==='Admin'); if(!isAdmin){ return '<div class="card"><div class="content"><div class="hint">Acceso restringido. Solo <b>Administradores</b> pueden gestionar usuarios.</div></div></div>'; } var rows=''; for(var i=0;i<state.usuarios.length;i++){ var u=state.usuarios[i]; rows+='<tr data-uid="'+u.id+'"><td>'+u.nombre+'</td><td class="hint">'+(u.email||'‚Äî')+'</td><td>'+u.rol+'</td><td><button class="btn red" data-act="udel" '+(state.currentUser&&state.currentUser.id===u.id?'disabled':'')+'>üóëÔ∏è Eliminar</button></td></tr>'; } return '<div class="row" style="gap:16px"><div class="toolbar"><span class="hint">Usuarios: <b>'+state.usuarios.length+'</b></span><button class="btn primary" id="usr-new">‚ûï Nuevo usuario</button></div>'+ table(['Nombre','Email','Rol','Acciones'], rows) +'</div>'; }

  function showUserForm(){ var html='<div class="overlay" id="usr-ov"><div class="dialog"><div class="content"><div class="title">Agregar usuario</div><div class="row cols-2"><div><label class="label">Nombre</label><input id="u-nombre" class="input"/></div><div><label class="label">Email</label><input id="u-email" type="email" class="input"/></div><div><label class="label">Rol</label><select id="u-rol" class="select"><option>Admin</option><option>Vendedor</option><option>Operador</option><option>Visor</option></select></div><div><label class="label">PIN (4-6 d√≠gitos)</label><input id="u-pin" type="password" class="input" placeholder="0000"/></div></div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button class="btn" id="u-cancel">Cancelar</button><button class="btn primary" id="u-save">Guardar</button></div></div></div></div>'; document.body.insertAdjacentHTML('beforeend',html); var ov=el('#usr-ov'); el('#u-cancel',ov).onclick=function(){ ov.remove(); }; el('#u-save',ov).onclick=function(){ var nombre=el('#u-nombre',ov).value.trim(); var email=el('#u-email',ov).value.trim(); var rol=el('#u-rol',ov).value; var pin=el('#u-pin',ov).value.trim(); if(!nombre||!pin){ alert('Nombre y PIN son obligatorios'); return; } setState(function(s){ var u={id:uid(), nombre:nombre, email:email, rol:rol, pin:pin}; var users=s.usuarios.slice(); users.unshift(u); return {usuarios:users}; }); ov.remove(); }; ov.addEventListener('click',function(e){ if(e.target===ov){ ov.remove(); } }); }

  // ===== CONTABILIDAD =====
  function renderContabilidad(){ var f=contaFiltros; return '<div class="row" style="gap:16px">'+ '<div class="card"><div class="content"><div style="font-weight:600; font-size:14px; margin-bottom:6px">Filtros</div><div class="row cols-4">'+ '<div><label class="label">Desde</label><input type="date" id="co-desde" class="input" value="'+(f.desde||'')+'"/></div>'+ '<div><label class="label">Hasta</label><input type="date" id="co-hasta" class="input" value="'+(f.hasta||'')+'"/></div>'+ '<div><label class="label">Estado</label><select id="co-estado" class="select">'+ ['Todos'].concat(STATUS).map(function(s){return '<option '+(s===f.estado?'selected':'')+'>'+s+'</option>';}).join('') +'</select></div>'+ '<div style="display:flex; align-items:flex-end"><button class="btn" id="co-aplicar">Aplicar</button></div>'+ '</div></div></div>'+ '<div id="co-cards" class="row cols-4"></div>'+ '<div class="toolbar"><button class="btn" id="co-export">‚¨áÔ∏è Exportar CSV (filtrado)</button></div>'+ '<div id="co-tabla"></div>'+ '</div>'; }
  function calcularContabilidad(){ var desde=contaFiltros.desde, hasta=contaFiltros.hasta, estado=contaFiltros.estado; var from=desde? new Date(desde+'T00:00:00'):null; var to=hasta? new Date(hasta+'T23:59:59'):null; var rows=[]; for(var i=0;i<state.pedidos.length;i++){ var p=state.pedidos[i]; var d=new Date(p.fecha); if(from && d<from) continue; if(to && d>to) continue; if(estado && estado!=='Todos' && p.estado!==estado) continue; rows.push(p); } var subtotal=0, envio=0, total=0, cod=0; for(var j=0;j<rows.length;j++){ var r=rows[j]; subtotal+=Number(typeof r.subtotal==='number'? r.subtotal : (r.total - (r.envio?r.envio.costo:0))); envio+=Number(r.envio?r.envio.costo:0); total+=Number(r.total||0); var first=(r.envio&&r.envio.couriers&&r.envio.couriers[0])? r.envio.couriers[0]:null; if(first && first.cod){ cod+=Number(first.codMonto||r.total); } } var promedio=rows.length? total/rows.length:0; var porEstado={}; for(var k=0;k<STATUS.length;k++){ var st=STATUS[k]; var c=0; for(var m=0;m<rows.length;m++){ if(rows[m].estado===st) c++; } porEstado[st]=c; } return { rows:rows, resumen:{subtotal:subtotal, envio:envio, total:total, cod:cod, promedio:promedio, conteo:rows.length, porEstado:porEstado} }; }
  function renderContabilidadContenido(){ var R=calcularContabilidad(); function card(t,v,d){ return '<div class="card"><div class="content"><div class="hint">'+t+'</div><div style="font-size:22px;font-weight:700">'+v+'</div><div class="hint">'+(d||'')+'</div></div></div>'; } var cards=''; cards+=card('Total vendido',currency(R.resumen.total)); cards+=card('Subtotal (sin env√≠o)',currency(R.resumen.subtotal)); cards+=card('Costos de env√≠o (principal)',currency(R.resumen.envio)); cards+=card('COD a cobrar',currency(R.resumen.cod)); cards+=card('Pedidos',R.resumen.conteo); cards+=card('Ticket promedio',currency(R.resumen.promedio)); cards+=card('Procesados',R.resumen.porEstado['Procesado']||0,'por estado'); cards+=card('Enviados',R.resumen.porEstado['Enviado']||0,'por estado'); var box=document.getElementById('co-cards'); if(box) box.innerHTML=cards; var body=''; for(var i=0;i<R.rows.length;i++){ var p=R.rows[i]; body+='<tr><td>'+p.codigo+'</td><td>'+new Date(p.fecha).toLocaleString('es-DO')+'</td><td>'+p.cliente.nombre+'</td><td>'+p.estado+'</td><td style="text-align:right">'+currency(p.total)+'</td></tr>'; } var tabla=table(['C√≥digo','Fecha','Cliente','Estado','Total'],body); var tb=document.getElementById('co-tabla'); if(tb) tb.innerHTML=tabla; }

  // ===== SCAN (simple: manual + BarcodeDetector si existe) =====
  function renderScan(){ return '<div class="card"><div class="content"><div class="title">Escanear entrega</div><div class="row cols-2"><div><label class="label">C√≥digo de pedido</label><input id="sc-code" class="input" placeholder="Ej: PED-123456"/></div><div style="display:flex;align-items:flex-end"><button class="btn primary" id="sc-ok">Marcar entregado</button></div></div><div class="hint" style="margin-top:8px">Opcional: usa c√°mara si tu navegador soporta <code>BarcodeDetector</code>.</div><div style="margin-top:10px"><button class="btn" id="sc-cam">üì∑ Escanear con c√°mara</button></div><video id="sc-video" autoplay playsinline style="width:100%;max-height:260px;border-radius:12px;margin-top:8px;display:none;border:1px solid var(--border)"></video></div></div>'; }
  function startScan(){ var btn=el('#sc-cam'); var vid=el('#sc-video'); if(!('BarcodeDetector' in window)){ alert('BarcodeDetector no disponible en este navegador. Usa la entrada manual.'); return; } navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}}).then(function(stream){ vid.style.display='block'; vid.srcObject=stream; var detector=new window.BarcodeDetector({formats:['qr_code','code_128','code_39']}); var rafId; function tick(){ detector.detect(vid).then(function(codes){ if(codes && codes.length){ var v=codes[0].rawValue||codes[0].raw || ''; if(v){ el('#sc-code').value=v; markDelivered(v); stop(); } } rafId=requestAnimationFrame(tick); }).catch(function(){ rafId=requestAnimationFrame(tick); }); } tick(); function stop(){ try{ cancelAnimationFrame(rafId); }catch(e){} try{ stream.getTracks().forEach(function(t){t.stop();}); }catch(e){} vid.style.display='none'; }
    btn.textContent='Detener c√°mara'; btn.onclick=stop; }).catch(function(){ alert('No se pudo acceder a la c√°mara.'); }); }
  function markDelivered(code){ var idx=-1; for(var i=0;i<state.pedidos.length;i++){ if(state.pedidos[i].codigo===code){ idx=i; break; } } if(idx<0){ alert('Pedido no encontrado'); return; } setState(function(s){ var arr=s.pedidos.slice(); arr[idx]={id:arr[idx].id, codigo:arr[idx].codigo, fecha:arr[idx].fecha, cliente:arr[idx].cliente, envio:arr[idx].envio, items:arr[idx].items, subtotal:arr[idx].subtotal, notas:arr[idx].notas, comprobante:arr[idx].comprobante, total:arr[idx].total, estado:'Entregado'}; return {pedidos:arr}; }); alert('Pedido '+code+' marcado como ENTREGADO'); currentTab='pedidos'; }

  // ===== LAYOUT / RENDER ROOT =====
  function layout(){ var authed=!!(state&&state.currentUser); var body=( currentTab==='inventario'?renderInventario() : currentTab==='pedidos'?renderPedidos() : currentTab==='clientes'?renderClientes() : currentTab==='conta'?renderContabilidad() : currentTab==='usuarios'?renderUsuarios() : currentTab==='scan'?renderScan() : renderForm() ); var help=(!authed && currentTab==='form')? '<div class="row layout-5" style="gap:16px; margin-top:12px"><div></div><div><div class="card"><div class="content"><div style="font-weight:600; margin-bottom:8px">Modo p√∫blico</div><div class="hint">Para ver Inventario, Pedidos, Contabilidad y Usuarios, inicia sesi√≥n con tu cuenta.</div></div></div></div></div>':''; return renderHeader()+renderTabs()+body+help; }

  function render(){
    var app=el('#app');
    app.innerHTML=layout();

    // Navegaci√≥n por pesta√±as (desktop)
    els('[data-tab]').forEach(function(n){
      n.onclick=function(){
        var target=n.getAttribute('data-tab');
        var authed=!!(state&&state.currentUser);
        if(!authed && target!=='form'){ alert('Debes iniciar sesi√≥n'); openLogin(); return; }
        currentTab=target; render();
      };
    });

    // Botones de sesi√≥n
    var loginBtn=el('#btn-login'); if(loginBtn) loginBtn.onclick=openLogin;
    var logoutBtn=el('#btn-logout'); if(logoutBtn) logoutBtn.onclick=function(){ setState({ currentUser:null }); };

    if(currentTab==='inventario'){
      var canEdit=(state.currentUser&&state.currentUser.rol==='Admin');
      var btnNew=el('#btn-new-product'); if(btnNew) btnNew.onclick=function(){ if(canEdit) showProductoForm(null); else alert('Solo administradores'); };
      els('[data-act="edit-product"]').forEach(function(b){ b.onclick=function(){ if(canEdit) showProductoForm(b.getAttribute('data-id')); else alert('Solo administradores'); }; });
      els('[data-act="del-product"]').forEach(function(b){ b.onclick=function(){ if(!canEdit){ alert('Solo administradores'); return; } if(confirm('¬øEliminar producto?')){ setState(function(s){ var inv=[]; for(var i=0;i<s.inventario.length;i++){ if(s.inventario[i].id!==b.getAttribute('data-id')) inv.push(s.inventario[i]); } return {inventario:inv}; }); } }; });
    }

    if(currentTab==='form'){
      var lines=[{id:uid(), productoId:(state.inventario[0]?state.inventario[0].id:''), cantidad:1}];
      var couriers=[{id:uid(), courier:'', sucursal:'', costo:0, cod:false, codMonto:0}];
      var comp=null; // comprobante
      var linesBox=el('#lines'); var courBox=el('#couriers'); var totBox=el('#totales');

      function refresh(){
        linesBox.innerHTML=renderLines(lines);
        courBox.innerHTML=renderCouriers(couriers);
        var primary=couriers[0]||{costo:0};
        var prodList=lines.map(function(l){
          var p=null; for(var i=0;i<state.inventario.length;i++){ if(state.inventario[i].id===l.productoId){ p=state.inventario[i]; break; } }
          return { nombre:(p?p.nombre:''), precio:Number(p?p.precio:0), cantidad:Number(l.cantidad||0) };
        });
        var t=calcTotales(prodList, primary.costo||0);
        totBox.innerHTML='<div style="display:flex;justify-content:space-between"><span class="hint">Subtotal</span><b>'+currency(t.subtotal)+'</b></div>'+
                         '<div style="display:flex;justify-content:space-between"><span class="hint">Env√≠o (courier principal)</span><b>'+currency(t.envio)+'</b></div>'+
                         '<div style="display:flex;justify-content:space-between"><span style="font-weight:600">Total</span><b style="font-weight:600">'+currency(t.total)+'</b></div>';
        // listeners por l√≠nea
        els('[data-line]').forEach(function(box){
          var id=box.getAttribute('data-line');
          el('[data-role="prod"]',box).onchange=function(e){ var v=e.target.value; for(var i=0;i<lines.length;i++){ if(lines[i].id===id){ lines[i].productoId=v; break; } } refresh(); };
          el('[data-role="cant"]',box).oninput=function(e){ var v=Number(e.target.value||1); for(var i=0;i<lines.length;i++){ if(lines[i].id===id){ lines[i].cantidad=v; break; } } refresh(); };
          el('[data-role="rm"]',box).onclick=function(){ if(lines.length>1){ for(var i=0;i<lines.length;i++){ if(lines[i].id===id){ lines.splice(i,1); break; } } refresh(); } };
        });
        // listeners couriers
        els('[data-courier]').forEach(function(box){
          var id=box.getAttribute('data-courier'); var C=null; for(var i=0;i<couriers.length;i++){ if(couriers[i].id===id){ C=couriers[i]; break; } }
          var cSel=el('[data-role="courier"]',box), sInp=el('[data-role="sucursal"]',box), coInp=el('[data-role="costo"]',box), cod=el('[data-role="cod"]',box), codm=el('[data-role="codm"]',box), rmc=el('[data-role="rmc"]',box);
          if(cSel) cSel.onchange=function(e){ C.courier=e.target.value; };
          if(sInp) sInp.oninput=function(e){ C.sucursal=e.target.value; };
          if(coInp) coInp.oninput=function(e){ C.costo=Number(e.target.value||0); refresh(); };
          if(cod) cod.onchange=function(){ C.cod=!!cod.checked; if(codm) codm.disabled=!C.cod; };
          if(codm) codm.oninput=function(e){ C.codMonto=Number(e.target.value||0); };
          if(rmc) rmc.onclick=function(){ if(couriers.length>1){ for(var i=0;i<couriers.length;i++){ if(couriers[i].id===id){ couriers.splice(i,1); break; } } refresh(); } };
        });
      }
      refresh();
      el('#line-add').onclick=function(){ lines.push({id:uid(), productoId:(state.inventario[0]?state.inventario[0].id:''), cantidad:1}); refresh(); };
      el('#courier-add').onclick=function(){ couriers.push({id:uid(), courier:'', sucursal:'', costo:0, cod:false, codMonto:0}); refresh(); };
      var compFile=el('#comp-file'); if(compFile) compFile.onchange=function(e){ var f=e.target.files[0]; if(!f){ comp=null; el('#comp-preview').innerHTML=''; return; } if(f.type.indexOf('image/')!==0){ alert('Sube una imagen'); return; } if(f.size>2*1024*1024){ alert('La imagen debe ser menor a 2MB'); return; } fileToDataURL(f,function(u){ comp={name:f.name,type:f.type,size:f.size,dataUrl:u}; el('#comp-preview').innerHTML='<img src="'+u+'" style="max-height:160px;border:1px solid #e5e7eb;border-radius:10px"/>'+'<div class="hint" style="margin-top:4px">'+f.name+' ‚Ä¢ '+(f.size/1024).toFixed(0)+' KB</div>'; }); };
      var form=el('#order-form'); if(form) form.onsubmit=function(e){ e.preventDefault(); var nombre=el('[name="c-nombre"]').value.trim(); if(!nombre){ alert('Agrega el nombre del cliente'); return; } var telefono=el('[name="c-telefono"]').value.trim(); var modalidad=el('[name="env-modalidad"]').value; var primary=couriers[0]||{costo:0}; var prodList=[]; for(var i=0;i<lines.length;i++){ var L=lines[i]; var p=null; for(var j=0;j<state.inventario.length;j++){ if(state.inventario[j].id===L.productoId){ p=state.inventario[j]; break; } } if(!p) continue; prodList.push({ productoId:p.id, nombre:p.nombre, precio:Number(p.precio||0), cantidad:Number(L.cantidad||0), foto:p.foto||null }); }
        if(!prodList.length){ alert('Agrega al menos un producto'); return; }
        var t=calcTotales(prodList, primary.costo||0);
        var pedido={ id:uid(), codigo:'PED-'+Date.now().toString().slice(-6), fecha:new Date().toISOString(), cliente:{nombre:nombre, telefono:telefono}, envio:{ modalidad:modalidad, couriers:couriers.slice(), costo:t.envio }, items:prodList, subtotal:t.subtotal, notas:el('#order-notas').value, comprobante:comp, total:t.total, estado:'Nuevo' };
        setState(function(s){ var arr=s.pedidos.slice(); arr.unshift(pedido); return {pedidos:arr}; });
        alert('Pedido guardado: '+pedido.codigo); currentTab='pedidos'; render(); };
      var prevBtn=el('#a4-preview'); if(prevBtn) prevBtn.onclick=function(){ // vista previa con datos del formulario (sin guardar)
        var nombre=el('[name="c-nombre"]').value.trim(); if(!nombre){ alert('Completa el nombre'); return; }
        var telefono=el('[name="c-telefono"]').value.trim(); var modalidad=el('[name="env-modalidad"]').value; var primary=couriers[0]||{costo:0};
        var prodList=[]; for(var i=0;i<lines.length;i++){ var L=lines[i]; var p=null; for(var j=0;j<state.inventario.length;j++){ if(state.inventario[j].id===L.productoId){ p=state.inventario[j]; break; } } if(p){ prodList.push({ nombre:p.nombre, cantidad:Number(L.cantidad||0), precio:Number(p.precio||0) }); } }
        var t=calcTotales(prodList, primary.costo||0);
        var tmp={ codigo:'PREVIEW', fecha:new Date().toISOString(), cliente:{nombre:nombre, telefono:telefono}, envio:{ modalidad:modalidad, couriers:couriers.slice(), costo:t.envio }, items:prodList, subtotal:t.subtotal, notas:el('#order-notas').value, comprobante:comp, total:t.total, estado:'Nuevo' };
        printA4(tmp);
      };
    }

    if(currentTab==='pedidos'){
      var exp=el('#ped-export'); if(exp) exp.onclick=function(){ var rows=state.pedidos.map(function(p){ var first=(p.envio&&p.envio.couriers&&p.envio.couriers[0])?p.envio.couriers[0]:{}; return { codigo:p.codigo, fecha:new Date(p.fecha).toLocaleString('es-DO'), cliente:p.cliente.nombre, telefono:(p.cliente.telefono||''), modalidad:(p.envio?p.envio.modalidad:''), courier_principal:(first.courier||''), sucursal_principal:(first.sucursal||''), envio_costo:(p.envio?p.envio.costo:0), pago_contra_entrega:(first.cod?'S√≠':'No'), cod_monto:(first.cod?(first.codMonto||p.total):0), items:(p.items||[]).map(function(i){return i.nombre+' x'+i.cantidad;}).join('; '), tiene_comprobante:(p.comprobante&&p.comprobante.dataUrl?'S√≠':'No'), subtotal:(typeof p.subtotal==='number'?p.subtotal:(p.total-(p.envio?p.envio.costo:0))), total:p.total, estado:p.estado }; }); exportCSV(rows,'pedidos_'+Date.now()+'.csv'); };
      els('[data-pid]').forEach(function(row){ var id=row.getAttribute('data-pid');
        el('[data-role="estado"]',row).onchange=function(e){ setState(function(s){ var arr=s.pedidos.slice(); for(var i=0;i<arr.length;i++){ if(arr[i].id===id){ arr[i].estado=e.target.value; break; } } return {pedidos:arr}; }); };
        el('[data-act="proc"]',row).onclick=function(){ setState(function(s){ var arr=s.pedidos.slice(); for(var i=0;i<arr.length;i++){ if(arr[i].id===id){ arr[i].estado='Procesado'; break; } } return {pedidos:arr}; }); };
        el('[data-act="env"]',row).onclick=function(){ setState(function(s){ var arr=s.pedidos.slice(); for(var i=0;i<arr.length;i++){ if(arr[i].id===id){ arr[i].estado='Enviado'; break; } } return {pedidos:arr}; }); };
        el('[data-act="nota"]',row).onclick=function(){ var p=null; for(var i=0;i<state.pedidos.length;i++){ if(state.pedidos[i].id===id){ p=state.pedidos[i]; break; } } if(p) printA4(p); };
        el('[data-act="label"]',row).onclick=function(){ var p=null; for(var i=0;i<state.pedidos.length;i++){ if(state.pedidos[i].id===id){ p=state.pedidos[i]; break; } } if(p) printLabel4x6(p); };
        el('[data-act="del"]',row).onclick=function(){ if(!(state.currentUser&&state.currentUser.rol==='Admin')){ alert('Solo administradores pueden borrar pedidos.'); return; } setState(function(s){ var arr=[]; for(var i=0;i<s.pedidos.length;i++){ if(s.pedidos[i].id!==id) arr.push(s.pedidos[i]); } return {pedidos:arr}; }); };
      });
    }

    if(currentTab==='clientes'){
      var cliExp=el('#cli-export'); if(cliExp) cliExp.onclick=function(){ var map={}; state.pedidos.forEach(function(p){ var key=(p.cliente.telefono||p.cliente.nombre)||p.cliente.nombre; if(!map[key]) map[key]={nombre:p.cliente.nombre, telefono:(p.cliente.telefono||''), pedidos:0, total:0}; map[key].pedidos++; map[key].total+=p.total; }); var out=[]; for(var k in map){ out.push(map[k]); } exportCSV(out,'clientes_'+Date.now()+'.csv'); };
    }

    if(currentTab==='conta'){
      renderContabilidadContenido();
      var apply=el('#co-aplicar'); if(apply) apply.onclick=function(){ contaFiltros.desde=el('#co-desde').value; contaFiltros.hasta=el('#co-hasta').value; contaFiltros.estado=el('#co-estado').value; renderContabilidadContenido(); };
      var cexp=el('#co-export'); if(cexp) cexp.onclick=function(){ var R=calcularContabilidad(); var out=R.rows.map(function(p){ return {codigo:p.codigo, fecha:new Date(p.fecha).toLocaleString('es-DO'), cliente:p.cliente.nombre, estado:p.estado, subtotal:(typeof p.subtotal==='number'?p.subtotal:(p.total-(p.envio?p.envio.costo:0))), envio:(p.envio?p.envio.costo:0), total:p.total}; }); exportCSV(out,'contabilidad_'+Date.now()+'.csv'); };
    }

    if(currentTab==='usuarios'){
      var isAdmin=(state.currentUser&&state.currentUser.rol==='Admin');
      if(isAdmin){ var btn=el('#usr-new'); if(btn) btn.onclick=showUserForm; els('[data-act="udel"]').forEach(function(b){ b.onclick=function(){ var uidAttr=b.closest('[data-uid]').getAttribute('data-uid'); if(state.currentUser && state.currentUser.id===uidAttr){ alert('No puedes eliminar tu propio usuario activo.'); return; } setState(function(s){ var arr=[]; for(var i=0;i<s.usuarios.length;i++){ if(s.usuarios[i].id!==uidAttr) arr.push(s.usuarios[i]); } return {usuarios:arr}; }); }; }); }
    }

    if(currentTab==='scan'){
      var ok=el('#sc-ok'); if(ok) ok.onclick=function(){ var code=el('#sc-code').value.trim(); if(!code){ alert('Ingresa el c√≥digo'); return; } markDelivered(code); };
      var cam=el('#sc-cam'); if(cam) cam.onclick=startScan;
    }
  }

  function openLogin(){
    var html='<div class="overlay" id="login-modal"><div class="dialog"><div class="content">'+
      '<div class="title">Iniciar sesi√≥n</div>'+
      '<div class="row cols-2">'+
        '<div><label class="label">Usuario</label><select id="login-user" class="select">'+ state.usuarios.map(function(u){ return '<option value="'+u.id+'">'+u.nombre+' ‚Äî '+u.rol+'</option>'; }).join('') +'</select></div>'+
        '<div><label class="label">PIN</label><input id="login-pin" type="password" inputmode="numeric" class="input" placeholder="0000"/></div>'+
      '</div>'+
      '<div class="hint" style="margin-top:6px">Este login es local (PIN). Para uso en l√≠nea real usa un backend (Supabase).</div>'+
      '<div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px"><button class="btn" id="login-cancel">Cancelar</button><button class="btn primary" id="login-ok">üîê Ingresar</button></div>'+
    '</div></div></div>';
    document.body.insertAdjacentHTML('beforeend',html);
    var modal=el('#login-modal');
    el('#login-cancel',modal).onclick=function(){ modal.remove(); };
    el('#login-ok',modal).onclick=function(){ var id=el('#login-user',modal).value; var pin=el('#login-pin',modal).value; var u=null; for(var i=0;i<state.usuarios.length;i++){ if(state.usuarios[i].id===id){ u=state.usuarios[i]; break; } } if(!u) return; if(String(u.pin||'')!==String(pin||'')){ alert('PIN incorrecto'); return; } setState({ currentUser:{ id:u.id, nombre:u.nombre, rol:u.rol } }); modal.remove(); };
    modal.onclick=function(e){ if(e.target===modal) modal.remove(); };
  }

  // ======== SELF TESTS (m√≠nimos) ========
  function runSelfTests(){
    try{
      console.log('[Tests] Iniciando');
      if(typeof contaFiltros!=='object') throw new Error('contaFiltros no existe');
      var prev=state; state={ pedidos:[ { fecha:'2024-01-01T12:00:00Z', codigo:'T1', estado:'Nuevo', subtotal:1000, envio:{costo:200, couriers:[{cod:false}]}, total:1200, cliente:{nombre:'A'} }, { fecha:'2024-01-02T12:00:00Z', codigo:'T2', estado:'Enviado', subtotal:500, envio:{costo:100, couriers:[{cod:true, codMonto:400}]}, total:600, cliente:{nombre:'B'} } ] };
      contaFiltros={desde:'',hasta:'',estado:'Todos'};
      var r1=calcularContabilidad(); if(r1.resumen.total!==1800) throw new Error('Total esperado 1800'); if(r1.resumen.envio!==300) throw new Error('Env√≠o esperado 300'); if(r1.resumen.cod!==400) throw new Error('COD esperado 400');
      contaFiltros={desde:'',hasta:'',estado:'Enviado'}; var r2=calcularContabilidad(); if(!(r2.rows.length===1 && r2.rows[0].codigo==='T2')) throw new Error('Filtro por estado fall√≥');
      var okSVG = toCode39SVG('TEST123').indexOf('<svg')===0; if(!okSVG) throw new Error('Code39 SVG');
      state=prev; console.log('[Tests] OK');
    }catch(e){ console.error('[Tests] fallo', e); }
  }

  // ===== Boot =====
  (function boot(){ state=loadLocal(); render(); runSelfTests(); })();

})();
</script>
</body>
</html>
